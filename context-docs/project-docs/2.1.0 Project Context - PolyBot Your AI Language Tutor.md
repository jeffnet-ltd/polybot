Version: 2.1.0 (Stable, Verified, Production Ready)

Status: Production Ready - Full A1 Curriculum (10 Modules) + GPTQ Quantization + Azure TTS + Gendered Voices

Last Updated: 2025-12-11

Dev Environment: HP EliteBook 820 G4 / Windows 11 WSL2 (NVIDIA RTX 2080 Ti) → **Migrating to RunPod Serverless GPU**

## Executive Summary

Polybot is an **AI-powered multilingual language learning platform** combining a structured **10-module CEFR A1 Curriculum** with AI roleplay for "True Bilingual" learning (target language + native language explanations).

**Current Status:** Complete A1 curriculum, GPTQ quantization, Whisper STT, Azure Speech TTS with gendered character voices. Scenario-Based Practice Mode architecture designed. Migrating to serverless cloud architecture for global deployment.

---

## Technical Architecture (V2.1 - Current Stable)

### Stack Overview

- **Frontend:** React 18.2.0 + Tailwind CSS + Lucide React

    - **Deployment:** **Vercel / Netlify** (Free Tier)

- **Backend:** FastAPI (Python 3.11) + **Llama 3 8B Instruct (GPTQ Quantized)**

    - **Deployment:** **RunPod Serverless GPU** (Flex Workers for cost-efficiency)

- **Auth:** Google OAuth 2.0 (via `authlib`) + Local Session Management

- **Database:** MongoDB 7.0 → **MongoDB Atlas (Free Tier)**

- **Testing:** `pytest` suite with `AsyncMock` for backend logic verification.

- **Infrastructure:** Docker + Docker Compose (V2) - **Migrating to Serverless Endpoints.**

### Model Quantization

**Status:** ✅ Implemented

- **Quantization Method:** GPTQ (4-bit quantization via `auto-gptq`)
- **Model:** `TheBloke/Llama-3-8B-Instruct-GPTQ`
- **VRAM Usage:** ~5.5GB (down from ~16GB for FP16)
- **Performance:** Maintains high quality with 3x memory reduction
- **Implementation:** Auto-detection via transformers' `AutoModelForCausalLM` when `auto-gptq` is installed
- **CUDA Extensions:** Optional CUDA extensions for improved performance (pre-built wheels for CUDA 11.8/12.1)

**Migration Notes:**
- Removed deprecated AutoAWQ (no longer maintained)
- Switched to actively maintained GPTQ solution
- Compatible with transformers >=4.40.0
- Graceful fallback to standard model loading if GPTQ unavailable

### Voice Integration (Implemented - Final Stack)

|**Component**|**Status**|**Model**|**Technical Justification**|
|---|---|---|---|
|**Speech-to-Text (STT)**|**✅ Implemented**|**Whisper (OpenAI)**|Integrated for Echo Chamber exercises and Boss Fight voice input. Provides accurate transcription for pronunciation feedback.|
|**Text-to-Speech (TTS)**|**✅ Implemented (Primary)**|**Azure Speech Services**|**Primary & sole TTS provider.** Provides high availability, consistent voice quality, and reliable performance. Replaces Edge-TTS entirely due to DNS instability in containerized environments.|
|**Gendered Character Voices**|**✅ Implemented**|**Azure Neural Voices (Gender-Specific)**|**Character-aware voice selection** - Male and female voices mapped to character genders (Sofia→Female, Marco→Male, etc.) for enhanced learner immersion.|

### Hardware Requirement

- **AI Model:** Llama 3 8B Instruct (GPTQ quantized) will be hosted on **RunPod Serverless GPUs** (e.g., A40, L40S, or RTX 4090) using Docker containers.

- **Load Management:** **Model Ducking (VRAM Swapping)** and **GPTQ 4-bit Quantization** implemented to efficiently manage the concurrent VRAM load of Llama 3 and the Voice models (Whisper) on the shared GPU instance.

---

## Implemented Features (v2.1.0)

### Complete A1 Curriculum: 10 Modules ✅

All modules (A1.1-A1.10) fully implemented with 8-9 lessons each (Self-Assessment + content lessons + Boss Fight).

|Module|Topic|Key Grammar|Boss Fight Scenario|
|---|---|---|---|
|**A1.1**|Greetings & Introductions|Pronouns, "Essere", Articles, Nationalities|Meeting a Neighbor|
|**A1.2**|Personal Information & Family|"Avere", Numbers 0-20, Professions, Possessives|Library Registration|
|**A1.3**|Home & Housing|"C'è/Ci sono", Prepositions, Colors|Real Estate Viewing|
|**A1.4**|Food & Drinks|"Vorrei", "Prendere", Plurals|Trattoria Dinner|
|**A1.5**|Shopping & Prices|Demonstratives, "Quanto", "Costare/Comprare"|Market Haggle|
|**A1.6**|Directions & Transportation|Imperative, "Andare", Movement Prepositions|Lost Tourist|
|**A1.7**|Time & Daily Routines|Present Simple (-ARE verbs), Time expressions|Job Interview|
|**A1.8**|Weather & Seasons|Weather expressions, "Fare", Clothing|Vacation Planning|
|**A1.9**|Hobbies & Interests|"Piacere", Preferences, -ERE verbs|Club Membership|
|**A1.10**|Health & Body Parts|Body vocabulary, Health expressions, Ailments|Pharmacy Consultation|

---

## Recent Updates (v2.1.0 - 2025-12-11)

### 1. Edge TTS Removal & Azure Primary Implementation ✅

**Removed:** Edge-TTS imports, `get_edge_tts_voice()`, diagnostic endpoints, test files (`test_tts.py`, `generate_audio.py`)

**Implemented:** Azure Speech Services as sole TTS provider for all endpoints:
- `/api/v1/voice/synthesize` - Dialogue exercises
- `/api/v1/voice/chat` - Voice chat
- `/api/practice/voice-chat` - Practice mode

**Performance:** 1-5 second latency reduction (no Edge-TTS timeout attempts)

**Files Modified:** `backend/server.py`, `backend/requirements.txt` (edge-tts removed), `frontend/src/utils/audio.js`

### 2. Gendered Character Voice Support ✅

**New File:** `backend/character_voices.py` - Character-gender mapping & voice selection system

**Character Mapping:** Sofia/Maria/Luisa/Anna (Female) | Marco/Luca/John (Male)

**Voice Pairs (8 Languages):**
|English|Italian|French|Spanish|Portuguese|German|Japanese|Chinese|
|---|---|---|---|---|---|---|---|
|GuyNeural (M) / JennyNeural (F)|DiegoNeural (M) / ElsaNeural (F)|HenriNeural (M) / DeniseNeural (F)|AlvaroNeural (M) / ElviraNeural (F)|AntonioNeural (M) / FranciscaNeural (F)|ConradNeural (M) / KatjaNeural (F)|KeitaNeural (M) / NanamiNeural (F)|YunxiNeural (M) / XiaoxiaoNeural (F)|

**How It Works:** Character names extracted from dialogue ("Marco: Ciao!" → Marco) → Gender lookup → Language-specific voice selected

**Key Functions:** `get_character_gender()`, `get_voice_for_character()`, `extract_character_name()`

**System Responses:** Polybot AI uses default female voice for consistency

**Future Expansion:** Add characters to `CHARACTER_GENDERS` dictionary - system auto-detects

---

## Roadmap: Next Steps (Priority)

1. **✅ TTS High Availability (Completed v2.1.0):** Azure Speech Services as sole provider with gendered character voices

2. **Streaming Pipeline Implementation:**
    - Stream LLM output sentence-by-sentence to TTS
    - Stream TTS audio chunks back to client in real-time
    - Target: Reduce latency from ~6s to ~1.5s

3. **Scenario-Based Practice Mode:** Game State Architecture, Stage Manager patterns, Goal Check Classifier, Post-Game Report, Voice/Text toggle, scenario library

4. **✅ Core Curriculum Complete:** All 10 A1 modules fully implemented

5. **Cloud Migration ("The Hub"):**
    - Backend: RunPod Serverless GPU
    - Database: MongoDB Atlas
    - Frontend: Vercel/Netlify

6. **Mobile App Conversion:** Capacitor-based native apps (Android/iOS) pointing to cloud backend

7. **Code Cleanup:** Resolve Pydantic V2 and FastAPI `lifespan` deprecation warnings

8. **Global Expansion (Multi-Language Support):**
    - Deploy multiple LLMs (Llama-3-8B for European, Qwen-2.5-7B for Asian, Aya-Expanse-8B for African languages)
    - MultiLLMManager for dynamic language-specific model loading
    - Language-specific curriculum modules (e.g., `a1_1_module_data_es.py` for Spanish)

---

## Technical Notes

### Model Quantization
- **Method:** GPTQ (4-bit via `auto-gptq`) - ~5.5GB VRAM vs 16GB FP16
- **Auto-Detection:** `AutoModelForCausalLM.from_pretrained()` detects GPTQ format automatically
- **Fallback:** Gracefully reverts to standard loading if GPTQ unavailable
- **Config:** Model name via `MODEL_NAME` environment variable

### Voice Stack Architecture
- **TTS:** Azure Speech Services (sole provider) + gendered character voices
- **STT:** Whisper for transcription (Echo Chamber & Boss Fight)
- **Character Recognition:** Automatic name extraction from dialogue text ("Marco: Ciao!" → Marco)
- **System Responses:** Polybot AI uses default female voice
- **Performance:** No timeout failures (Azure 99.9% SLA)

### Practice Mode Architecture
- **State Management:** scene_status, win conditions, conversation history tracked in backend
- **System Prompts:** Stage Manager Pattern templates in configuration
- **Goal Detection:** Llama 3 Instruct with JSON response parsing
- **Feedback:** Separate LLM calls for Post-Game Report generation
- **UI Separation:** Voice and Text modes never mix

### Data Structure
- **Curriculum:** `backend/a1_1_module_data.py` through `a1_10_module_data.py` (hierarchical lesson/exercise organization)
- **Character Voices:** `backend/character_voices.py` (easy maintenance/expansion)
- **Validation:** Context-aware logic in `frontend/src/App.jsx`
- **Exercise Fields:** `audio_text` (listening), `common_mistakes`, `review`, `extension`, `cultural_note`, `required_elements`, `form_fields`

### Key Files

**Frontend:** `frontend/src/App.jsx` (main app), `PushToTalkButton.jsx` (to be created)

**Backend Core:** `backend/server.py` (FastAPI endpoints), `practice_mode.py` (scenario logic), `scenario_templates.py` (prompts), `character_voices.py` (NEW v2.1.0 - voice mapping)

**Curriculum:** `backend/a1_1_module_data.py` through `a1_10_module_data.py` (10 modules), `backend/scripts/seed_*.py` (MongoDB seeding)

**Config/Deployment:** `backend/requirements.txt` (dependencies), `backend/Dockerfile`, `docker-compose.yml`

**Documentation:** `context-docs/course-docs/The PolyBot A1 Curriculum Master Reference.md`, `context-docs/project-docs/2.1.0 Project Context - PolyBot Your AI Language Tutor.md`

---

## Version History

**v2.1.0 (Current - 2025-12-11):** Azure TTS as sole provider, gendered character voices, 1-5s latency reduction

**v2.0.0 (2025-01-XX):** Complete A1 curriculum (10 modules), GPTQ quantization, Whisper STT, Practice mode architecture

---

## Notes for Development

- **Character Expansion:** Add to `CHARACTER_GENDERS` in `character_voices.py` - system auto-detects
- **Voice Quality:** All Azure Neural voices at equivalent quality; consistent male/female pairs
- **TTS Finality:** Azure is the definitive TTS solution; no alternative providers planned
- **Cost:** Azure usage minimal and within free tier
- **Reliability:** Azure 99.9% SLA (no DNS/containerization issues like Edge-TTS)
